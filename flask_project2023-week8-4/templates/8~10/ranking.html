<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>

<body>

    {% extends "index.html" %}
    {% block section %}
    <div class="main-header">
        <h1 class="main-header__title"> 이화여자대학교 월간 랭킹 </h1>
        <hr class="main-hr">
    </div>

    <div class="outer">
        <div class="signup-inner">
            <br>
            <form action="{{ url_for('ranking') }}" method="get" id="collegeForm">
            <button onclick="changeCollege('all')" class="btn10-active" value="all" {% if college == "all" %}selected{% endif %}>전체</button>
            <button onclick="changeCollege('대학1')" class="btn10" value="대학1" {% if college == "대학1" %}selected{% endif %}>인문과학대학</button>
            <button onclick="changeCollege('대학2')" class="btn10" value="대학2" {% if college == "대학2" %}selected{% endif %}>사회과학대학</button>
            <button class="btn10" value="대학3" {% if college == "대학3" %}selected{% endif %}>자연과학대학</button>
            <button class="btn10" value="대학4" {% if college == "대학4" %}selected{% endif %}>엘텍공과대학</button>
            <button class="btn10" value="대학5" {% if college == "대학5" %}selected{% endif %}>음악대학</button>
            <button class="btn10" value="대학6" {% if college == "대학6" %}selected{% endif %}>조형예술대학</button>
            <button class="btn10" value="대학7" {% if college == "대학7" %}selected{% endif %}>사범대학</button><br>
            <button class="btn10" value="대학8" {% if college == "대학8" %}selected{% endif %}>경영대학</button>
            <button class="btn10" value="대학9" {% if college == "대학9" %}selected{% endif %}>신산업융합대학</button>
            <button class="btn10" value="대학10" {% if college == "대학10" %}selected{% endif %}>의과대학</button>
            <button class="btn10" value="대학11" {% if college == "대학11" %}selected{% endif %}>간호대학</button>
            <button class="btn10" value="대학12" {% if college == "대학12" %}selected{% endif %}>약학대학</button>
            <button class="btn10" value="대학13" {% if college == "대학13" %}selected{% endif %}>스크랜튼대학</button>
            <button class="btn10" value="대학14" {% if college == "대학14" %}selected{% endif %}>인공지능대학</button>
            <button class="btn10" value="대학15" {% if college == "대학15" %}selected{% endif %}>호크마교양대학</button><br><br>  
            </form>  
        </div><br> 

        <!--랭킹 순위 별 프로필, 포인트 불러오기 백엔드 연동 필요: 유저네임, 유저프로필(img),  포인트(range의 value) 값 넣기-->
        <div class="ranking-inner">
            <p class="warning-msg">*총 거래 포인트(판매포인트+구매포인트)를 기준으로 한 상위 10명입니다.</p>
            {% if session['id'] %}           
            <p>{{session['id']}}님의 랭킹포인트는 {{ user_rankingpoint }}p입니다.</p>  
            {% else%}
            <p>랭킹포인트 확인을 위해 로그인을 해주세요.</p>
            {% endif %}

            <!--동적으로 랭킹을 가져오는 코드-->
            <table style="margin:auto;">
                {% for rank, user_data in datas %}
                    <tr>
                        <td>{{ rank }}</td>
                        <td><img src="{{ user_data['profile_image'] }}"></td>
                        <td>{{ user_data['username'] }}</td>
                        <td>
                            <div class="bar-container">
                                <div class="bar" id="bar{{ rank }}"></div>
                            </div>
                        </td>
                        <td>{{ user_data['rankingpoint'] }}</td>
                    </tr>
                {% endfor %}
            </table>
        </div>

    </div>

    <!-- 선택된 college에 따라 상위 10위 랭킹 동적으로 구현하기 -->
    <script>
        function changeCollege(college) {
            fetch("/update_ranking", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    college: college,
                }),
            })
            .then(response => response.json())
            .then(data => {
                updateRanking(data);
                updateButtonStyle(college);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function updateRanking(data) {
            const table = document.querySelector("table");
            table.innerHTML = "";

            data.forEach(user => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${user.rank}</td>
                    <td><img src="${user.profile_image}"></td>
                    <td>${user.username}</td>
                    <td>
                        <div class="bar-container">
                            <div class="bar" style="width: ${user.rankingpoint_percentage}%"></div>
                        </div>
                    </td>
                    <td>${user.rankingpoint}</td>
                `;
                table.appendChild(row);
            });
        }
        
        //버튼 눌리면 색 바뀌게......왜 안되지......
        function updateButtonStyle(college) {
        // 모든 버튼에 대해 기본 클래스(btn10) 설정
        const buttons = document.querySelectorAll('.btn10');
        buttons.forEach(button => button.classList.remove(' .btn10-active'));

        // 선택된 대학에 대한 버튼에 btn10-active 클래스 추가
        const activeButton = document.querySelector(`.btn10[value="${college}"]`);
        activeButton.classList.add(' .btn10-active');
    }

    </script>

    {% for rank, user_data in datas %}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            setBarWidth('bar{{ rank }}', {{ user_data['rankingpoint'] }});
        });

        function setBarWidth(barId, value) {
            const bar = document.getElementById(barId);
            const width = (value / 1000000) * 100; // 범위를 백분율로 변환
            bar.style.width = width + '%';
        }
    </script>

    {% endfor %}

    

    <link rel="stylesheet" href="../../static/style.css">
    <link rel="stylesheet" href="../../static/8~10Style.css">
    {% endblock section %}
</body>
</html>
